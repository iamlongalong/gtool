# é¡¹ç›®ç»“æ„

```
opengit/
â”œâ”€â”€ ğŸ“„ github-clone-open.user.js    # æ²¹çŒ´è„šæœ¬ï¼ˆå‰ç«¯ï¼‰
â”œâ”€â”€ ğŸš€ server.js                     # Node.js HTTP æœåŠ¡å™¨
â”œâ”€â”€ ğŸ§ª test-server.js                # æœåŠ¡å™¨æµ‹è¯•è„šæœ¬
â”œâ”€â”€ ğŸ“¦ package.json                  # Node.js é¡¹ç›®é…ç½®
â”œâ”€â”€ ğŸ¬ start.sh                      # æœåŠ¡å¯åŠ¨è„šæœ¬
â”œâ”€â”€ ğŸ“– README.md                     # å®Œæ•´æ–‡æ¡£
â”œâ”€â”€ ğŸš€ QUICKSTART.md                 # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ ğŸ“‹ PROJECT_STRUCTURE.md          # æœ¬æ–‡ä»¶
â””â”€â”€ ğŸ™ˆ .gitignore                    # Git å¿½ç•¥æ–‡ä»¶
```

## æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### å‰ç«¯ï¼šgithub-clone-open.user.js

æ²¹çŒ´è„šæœ¬ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚

**ä¸»è¦ç±»ï¼š**

| ç±»å | èŒè´£ | æ ¸å¿ƒæ–¹æ³• |
|------|------|----------|
| `ConfigManager` | é…ç½®ç®¡ç† | `get()`, `set()`, `showConfigDialog()` |
| `GitHubParser` | è§£æ GitHub é¡µé¢ | `parse()`, `getDefaultBranch()` |
| `CommandBuilder` | æ„å»º Shell è„šæœ¬ | `build()`, `buildRequest()` |
| `HttpClient` | HTTP é€šä¿¡ | `send()` |
| `UIManager` | UI ç®¡ç† | `createButton()`, `setLoading()`, `showNotification()` |
| `CloneOpenController` | ä¸»æ§åˆ¶å™¨ | `init()`, `handleCloneOpen()` |

**ç‰¹æ€§ï¼š**
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œå•ä¸€èŒè´£
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… ç»“æ„åŒ–æ§åˆ¶å°æ—¥å¿—
- âœ… PJAX å¯¼èˆªæ”¯æŒ
- âœ… å“åº”å¼ UI

### åç«¯ï¼šserver.js

Node.js HTTP æœåŠ¡å™¨ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

| å‡½æ•° | èŒè´£ |
|------|------|
| `validateCommand()` | éªŒè¯å‘½ä»¤å®‰å…¨æ€§ |
| `executeCommand()` | æ‰§è¡Œ Shell å‘½ä»¤ |
| `handleApiRequest()` | å¤„ç† API è¯·æ±‚ |
| `handleHealthCheck()` | å¥åº·æ£€æŸ¥ |

**ç‰¹æ€§ï¼š**
- âœ… å®‰å…¨éªŒè¯ï¼ˆæ‹’ç»å±é™©å‘½ä»¤ï¼‰
- âœ… CORS æ”¯æŒ
- âœ… è¶…æ—¶æ§åˆ¶
- âœ… è¯¦ç»†æ—¥å¿—
- âœ… ä¼˜é›…å…³é—­

### æµ‹è¯•ï¼štest-server.js

æœåŠ¡å™¨åŠŸèƒ½æµ‹è¯•å¥—ä»¶ã€‚

**æµ‹è¯•åœºæ™¯ï¼š**
1. âœ… ç®€å•å‘½ä»¤æ‰§è¡Œï¼ˆechoï¼‰
2. âœ… æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆlsï¼‰
3. âœ… Shell è„šæœ¬æ‰§è¡Œï¼ˆbash -cï¼‰
4. âœ… Git æ“ä½œæ¨¡æ‹Ÿ
5. âœ… å®‰å…¨éªŒè¯ï¼ˆæ‹’ç» rmï¼‰
6. âœ… Bash è„šæœ¬ä¸­çš„å±é™©å‘½ä»¤æ£€æµ‹

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»    â”‚
â”‚   æŒ‰é’®      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHubParser                   â”‚
â”‚  è§£æé¡µé¢ï¼Œæå–ï¼š                  â”‚
â”‚  - username, repo               â”‚
â”‚  - branch, tag, commit          â”‚
â”‚  - path                         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CommandBuilder                 â”‚
â”‚  æ ¹æ®ä»“åº“ä¿¡æ¯å’Œé…ç½®æ„å»ºï¼š           â”‚
â”‚  - Shell è„šæœ¬                    â”‚
â”‚  - HTTP è¯·æ±‚ä½“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HttpClient                     â”‚
â”‚  å‘é€ POST è¯·æ±‚åˆ°ï¼š               â”‚
â”‚  http://localhost:8080/api/v1/exec â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.js (Node.js)            â”‚
â”‚  1. éªŒè¯å‘½ä»¤å®‰å…¨æ€§                â”‚
â”‚  2. æ‰§è¡Œ Shell è„šæœ¬              â”‚
â”‚  3. è¿”å›æ‰§è¡Œç»“æœ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ                     â”‚
â”‚  - git clone/pull               â”‚
â”‚  - git checkout                 â”‚
â”‚  - æ‰“å¼€ç¼–è¾‘å™¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®å­˜å‚¨

### å‰ç«¯é…ç½®ï¼ˆGM_setValueï¼‰

å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼ˆé€šè¿‡ Tampermonkeyï¼‰ï¼š

```javascript
{
  apiUrl: "http://localhost:8080/api/v1/exec",
  baseDir: "~/code",
  editor: "code",
  defaultBranch: "main",
  openInEditor: true
}
```

### åç«¯é…ç½®ï¼ˆç¯å¢ƒå˜é‡ï¼‰

```bash
PORT=8080           # æœåŠ¡ç«¯å£
HOST=localhost      # ç›‘å¬åœ°å€
```

## API è®¾è®¡

### POST /api/v1/exec

**è¯·æ±‚ï¼š**
```json
{
  "command": "bash",
  "args": ["-c", "shell script"],
  "workdir": "/path/to/workdir",
  "env": {"KEY": "VALUE"}
}
```

**å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š**
```json
{
  "success": true,
  "exitCode": 0,
  "stdout": "è¾“å‡ºå†…å®¹",
  "stderr": "",
  "duration": 1234,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**å“åº”ï¼ˆå¤±è´¥ï¼‰ï¼š**
```json
{
  "success": false,
  "exitCode": 1,
  "stdout": "",
  "stderr": "é”™è¯¯ä¿¡æ¯",
  "error": "Command failed",
  "duration": 1234,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**å“åº”ï¼ˆå®‰å…¨æ‹¦æˆªï¼‰ï¼š**
```json
{
  "error": "Command rejected for security reasons",
  "reason": "Command contains dangerous pattern: \\brm\\b"
}
```

### GET /health

**å“åº”ï¼š**
```json
{
  "status": "ok",
  "uptime": 3600,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## å®‰å…¨å±‚

### 1. å‘½ä»¤éªŒè¯å±‚

```javascript
const DANGEROUS_PATTERNS = [
    /\brm\b/i,           // rm å‘½ä»¤
    /\bformat\b/i,       // format å‘½ä»¤
    /\bdel\b/i,          // del å‘½ä»¤
    />\s*\/dev\/sd/i,    // ç›´æ¥å†™ç£ç›˜
    /:\(\)\{.*:\|:.*\}/i // Fork bomb
];
```

### 2. æ‰§è¡Œé™åˆ¶å±‚

- â±ï¸ è¶…æ—¶ï¼š5 åˆ†é’Ÿ
- ğŸ“¦ è¾“å‡ºé™åˆ¶ï¼š10MB
- ğŸ  é»˜è®¤å·¥ä½œç›®å½•ï¼šå½“å‰ç›®å½•
- ğŸŒ ç½‘ç»œè®¿é—®ï¼šä»…æœ¬åœ°ï¼ˆlocalhostï¼‰

### 3. æ—¥å¿—å®¡è®¡å±‚

æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè®°å½•ï¼š
- æ—¶é—´æˆ³
- å‘½ä»¤å†…å®¹
- æ‰§è¡Œç»“æœ
- é”™è¯¯ä¿¡æ¯

## æ‰©å±•ç‚¹

### æ·»åŠ æ–°çš„ç¼–è¾‘å™¨æ”¯æŒ

ä¿®æ”¹ `CommandBuilder.build()` ä¸­çš„ç¼–è¾‘å™¨æ‰“å¼€é€»è¾‘ï¼š

```javascript
if (editor === 'idea') {
    script += `idea "${targetPath}"\n`;
} else if (editor === 'subl') {
    script += `subl "${targetPath}"\n`;
}
```

### æ·»åŠ æ–°çš„å®‰å…¨è§„åˆ™

åœ¨ `server.js` ä¸­æ·»åŠ æ–°çš„å±é™©æ¨¡å¼ï¼š

```javascript
const DANGEROUS_PATTERNS = [
    // ... ç°æœ‰è§„åˆ™
    /\bmkfs\b/i,  // æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ
    /\bdd\b/i,    // ç£ç›˜æ‹·è´ï¼ˆå¯èƒ½å±é™©ï¼‰
];
```

### æ·»åŠ é¢„å¤„ç†é’©å­

åœ¨ `CommandBuilder.build()` å‰æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼š

```javascript
preProcessRepoInfo(repoInfo) {
    // ä¾‹å¦‚ï¼šæ›¿æ¢ç‰¹å®šçš„ä»“åº“ URL
    if (repoInfo.username === 'company') {
        repoInfo.repoUrl = repoInfo.repoUrl.replace(
            'github.com',
            'git.company.com'
        );
    }
    return repoInfo;
}
```

### æ·»åŠ åå¤„ç†é’©å­

åœ¨å‘½ä»¤æ‰§è¡Œåæ·»åŠ è‡ªå®šä¹‰æ“ä½œï¼š

```javascript
postProcessCommand(result, repoInfo) {
    // ä¾‹å¦‚ï¼šé€šçŸ¥å…¶ä»–æœåŠ¡
    if (result.success) {
        notifySlack(`Cloned ${repoInfo.repo}`);
    }
}
```

## å¼€å‘å»ºè®®

### è°ƒè¯•å‰ç«¯

1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
2. æŸ¥çœ‹ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
3. åœ¨ `github-clone-open.user.js` ä¸­æ·»åŠ æ–­ç‚¹

### è°ƒè¯•åç«¯

1. åœ¨ `server.js` ä¸­æ·»åŠ  `console.log()`
2. ä½¿ç”¨ `npm test` è¿è¡Œæµ‹è¯•
3. æŸ¥çœ‹æœåŠ¡å™¨ç»ˆç«¯è¾“å‡º

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ Git shallow cloneï¼š`git clone --depth 1`
- ç¼“å­˜å¸¸ç”¨ä»“åº“
- å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚

### å®‰å…¨å¢å¼º

- æ·»åŠ è¯·æ±‚è®¤è¯ï¼ˆAPI Keyï¼‰
- é™åˆ¶å…è®¸çš„å‘½ä»¤ç™½åå•
- æ·»åŠ å®¡è®¡æ—¥å¿—
- å®ç°è¯·æ±‚é¢‘ç‡é™åˆ¶

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç 
4. åˆ›å»º Pull Request

æ¬¢è¿è´¡çŒ®ï¼
